From 8d87fcef9389218d2afa09e5a561df82b1286f4e Mon Sep 17 00:00:00 2001
From: Caedmon Judd <caedmon@statebuilt.com>
Date: Tue, 8 Nov 2011 07:48:14 -0600
Subject: [PATCH 54/55] Likes functionality

---
 app/cells/likes_list_widget/display.html.haml |   17 +++++++++--------
 app/cells/likes_list_widget_cell.rb           |    4 ++--
 app/controllers/likes_controller.rb           |    6 +++++-
 app/models/note.rb                            |   12 ++++++++----
 app/views/likes/index.html.haml               |   14 ++++++++++++++
 app/views/notes/show.html.haml                |    2 +-
 config/routes.rb                              |    1 +
 7 files changed, 40 insertions(+), 16 deletions(-)

diff --git a/app/cells/likes_list_widget/display.html.haml b/app/cells/likes_list_widget/display.html.haml
index 9a29494..6a4a4b9 100644
--- a/app/cells/likes_list_widget/display.html.haml
+++ b/app/cells/likes_list_widget/display.html.haml
@@ -11,11 +11,12 @@
             %a.more_arrow= link_to "All notes I like", @link
 
       %tbody
-        - @likes.first(5).each do |like|
-          %tr
-            %th
-              %a
-                %img.avatar_small{src: like.note_user_avatar_url.px_24x24}
-            %td
-              %a= link_to like.note_title, note_path(like.note_id)
-              %p= link_to "By #{like.note_username}", user_path(like.note_user_id)
+        - if @likes
+          - @likes.first(5).each do |like|
+            %tr
+              %th
+                %a
+                  %img.avatar_small{src: like.note_user_avatar_url.px_24x24}
+              %td
+                %a= link_to like.note_title, note_path(like.note_id)
+                %p= link_to "By #{like.note_username}", user_path(like.note_user_id)
diff --git a/app/cells/likes_list_widget_cell.rb b/app/cells/likes_list_widget_cell.rb
index aea073f..c3dc8fc 100644
--- a/app/cells/likes_list_widget_cell.rb
+++ b/app/cells/likes_list_widget_cell.rb
@@ -3,9 +3,9 @@ class LikesListWidgetCell < Cell::Rails
 
   def display(opts = {})
     @likes = opts[:likes]
-    @total = opts[:likes].count
+    @total = opts[:likes].count if opts[:likes]
     @title = opts[:title] ||= "Likes"
-    @link = opts[:link] ||= user_likes_path(opts[:user_id])
+    @link = opts[:link] ||= likes_path(opts[:user_id])
     render
   end
 
diff --git a/app/controllers/likes_controller.rb b/app/controllers/likes_controller.rb
index a132851..938d371 100644
--- a/app/controllers/likes_controller.rb
+++ b/app/controllers/likes_controller.rb
@@ -2,7 +2,11 @@ class LikesController < ApplicationController
   before_filter :set_nav
 
   def index
-    @likes = Like.all(current_user.id)
+    if params[:user_id]
+      @likes = Like.all(params[:user_id])
+    else
+      @likes = Like.all(current_user.id) #TODO: Remove User ID once the likes and notes are sync'd
+    end
   end
 
   private
diff --git a/app/models/note.rb b/app/models/note.rb
index c3a73d0..8b69b1c 100644
--- a/app/models/note.rb
+++ b/app/models/note.rb
@@ -23,6 +23,10 @@ class Note
     Like.for_note(id)
   end
 
+  def like_for_user
+    Like.for_note(id, auth.user_id)
+  end
+
   def self.find(id, auth = nil)
     response = YvApi.get('notes/view', id: id ) do |errors|   # anonymous
       YvApi.get('notes/view', id: id, auth: auth) do |errors| # auth'ed
@@ -60,6 +64,10 @@ class Note
   build_objects(response.notes, auth)
   end
 
+  def for_user(user_id)
+    self.class.for_user(user_id, auth)
+  end
+
   def self.for_reference(ref)
     response = YvApi.get('notes/items', reference: ref.notes_api_string) do |errors|
       puts errors
@@ -68,10 +76,6 @@ class Note
     end
   end
 
-  def for_user(user_id)
-    self.class.for_user(user_id, auth)
-  end
-
   def create
     @token = Digest::MD5.hexdigest "#{auth.username}.Yv6-#{auth.password}"
     @prexml_content = @content
diff --git a/app/views/likes/index.html.haml b/app/views/likes/index.html.haml
index e5c8063..fe830db 100644
--- a/app/views/likes/index.html.haml
+++ b/app/views/likes/index.html.haml
@@ -1,6 +1,20 @@
 %article
   - if request.path == user_likes_path(current_user)
     %h1= "My Likes"
+    %dl.combo_button.float_right
+      %dt View:
+      %dd
+        = link_to "All Likes", likes_path
+      %dd.highlighted
+        = link_to "My Likes", user_likes_path(current_user)
+  - else
+    %h1= "All Likes"
+    %dl.combo_button.float_right
+      %dt View:
+      %dd.highlighted
+        = link_to "All Likes", likes_path
+      %dd
+        = link_to "My Likes", user_likes_path(current_user)
   - if @likes
     %ul.big_list
       - @likes.each do |like|
diff --git a/app/views/notes/show.html.haml b/app/views/notes/show.html.haml
index 06c94f3..a026d5c 100644
--- a/app/views/notes/show.html.haml
+++ b/app/views/notes/show.html.haml
@@ -6,7 +6,7 @@
     %p
       = label_tag :user_status, "Note Status:"
       = @note.user_status
-      = button_to(@note.like.nil? ? 'like' : 'unlike', like_path(@note.id), :method => :put) if @note.user_status == 'public'
+      = button_to(@note.like_for_user.nil? ? 'like' : 'unlike', like_path(@note.id), :method => :put) if @note.user_status == 'public'
     - if current_auth.user_id == @note.user_id.to_i
       = link_to('edit', edit_note_path(@note.id)) 
       = link_to('delete this note', note_path(@note.id), :confirm => 'Are you sure?', :method => :delete) 
diff --git a/config/routes.rb b/config/routes.rb
index 40b26ce..c8ac6c9 100644
--- a/config/routes.rb
+++ b/config/routes.rb
@@ -4,6 +4,7 @@ YouversionWeb::Application.routes.draw do
   match 'bible(/:reference)' => 'references#show', :as => 'bible', :constraints => {:reference => /.*/}
   resources 'versions', :only => [:index, :show]
   resources 'notes'
+  resources 'likes', :only => [:index]
   match 'notes/:id/like' => 'notes#like',    :as => 'like', :via => :put
 
   # Users
-- 
1.7.0.4


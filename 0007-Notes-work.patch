From 5a12787f252d1809d660f2cde97afc4996a04dab Mon Sep 17 00:00:00 2001
From: Caedmon Judd <caedmon@statebuilt.com>
Date: Thu, 20 Oct 2011 13:25:50 -0500
Subject: [PATCH 07/55] Notes work

---
 app/controllers/notes_controller.rb |   16 ++++++++++++++++
 app/models/note.rb                  |   19 +++++++++++++++----
 2 files changed, 31 insertions(+), 4 deletions(-)

diff --git a/app/controllers/notes_controller.rb b/app/controllers/notes_controller.rb
index 58f006b..57953c7 100644
--- a/app/controllers/notes_controller.rb
+++ b/app/controllers/notes_controller.rb
@@ -32,9 +32,25 @@ class NotesController < ApplicationController
   end
   
   def update
+    @note = Note.find(params[:id], current_user)
+    @note.user = current_user 
+
+    if @note.update_attributes(params[:note])
+      render action: "show"
+    else
+      flash[:alert] = []
+      @note.errors.each do |error|       
+        flash.now[:alert] << error
+      end
+      render action: "edit"
+    end       
   end
   
   def delete
+    @note = Note.find(params[:id], current_user)
+    @note.destroy
+    
+    redirect_to '/'
   end
   
 end
diff --git a/app/models/note.rb b/app/models/note.rb
index 26e1be8..1e8b246 100644
--- a/app/models/note.rb
+++ b/app/models/note.rb
@@ -30,19 +30,21 @@ class Note
     end
   end
   
-  def self.find(id, user)
+  def self.find(id, user) #TODO: Refine to remove user parm
     response = YvApi.get('notes/view', {:id => id, :user => user} ) do |errors|     
       @errors = errors.map { |e| e["error"] }
       return false
     end
-    Note.new(response)
+    @note = Note.new(response)
+    @note.user = user
+    @note
   end
   
   def find(id, user)
     self.class.find(id, user)
   end
   
-  def self.all(user)
+  def self.all(user) #TODO: Refine to remove user parm
     response = YvApi.get('notes/items', {:user_id => user.id, :user => user} ) do |errors|     
       @errors = errors.map { |e| e["error"] }
       return false
@@ -66,6 +68,15 @@ class Note
       return false
     end
     response
-  end  
+  end
+  
+  def destroy
+    @token = Digest::MD5.hexdigest "#{user.username}.Yv6-#{user.password}"    
+    response = YvApi.post('notes/delete', attributes(:id, :user)) do |errors|
+      @errors = errors.map { |e| e["error"] }
+      return false
+    end
+    response
+  end
   
 end
-- 
1.7.0.4


// Current Parameters:
// presenter: Presenter::Sidebar::Subscription

:ruby
  subscription  = presenter.subscription
  day           = presenter.day
  reading       = presenter.reading
  content_page  = presenter.content_page
  references    = reading.references(version_id: subscription.version_id)

.mobile#mobile-sb-subscription{class: ('initial' if presenter.initial_load?)}
  .reader_modal_header
    %nav
      %a.close_btn.subscription_close_btn
    %nav.nav_right
      = link_to t("plan settings"), edit_subscription_path(user_id: current_user.to_param, id: subscription), class: "settings_btn"

#widget-plan-controls.widget

  - settings_text = t("settings")
  %div.hd
    = link_to subscription.name, plan_path(subscription)


  #calendar.bd.nopad.calendar
    - cal_text = t("plans.calendar")

    .calendar-prev
      - prev_text = t("plans.previous day") # used in 3 places below
      - if day > 1
        = link_to(subscription_path(user_id: current_user.to_param, id: subscription, day: ((day - 1) == subscription.current_day) ? nil : (day - 1), version: params[:version]), {class: "prev", title: prev_text }) do
          %span.calendar-arrows
            &nbsp;
          %span.calendar-arrow-txt
            = prev_text
      - else
        = link_to("#", class: "disabled prev") do
          %span.calendar-arrows
            &nbsp;
          %span.calendar-arrow-txt
            = prev_text

    .calendar-day
      =link_to(calendar_subscription_path(user_id: current_user.to_param, id: subscription), {title: cal_text }) do
        %h4
          = (subscription.respond_to?(:reading_date) ? subscription.reading_date(day) : current_date + (day - 1)).strftime('%a %b %-d')
        .mute
          = pluralize(references.size,t("plans.widget.reading"),t("plans.widget.readings"))

    .calendar-next
      - next_text = t("plans.next day") # used in 3 places below
      - if day <= subscription.total_days - 1
        = link_to(subscription_path(user_id: current_user.to_param, id: subscription, day: ((day + 1) == subscription.current_day) ? nil : (day + 1), version: params[:version]), {class: "next", title: next_text}) do
          %span.calendar-arrows
            &nbsp;
          %span.calendar-arrow-txt
            = next_text
      - else
        = link_to("#", class: "disabled next") do
          %span.calendar-arrows
            &nbsp;
          %span.calendar-arrow-txt
            = next_text

  .ft.calendar-links
    = link_to(plan_path(subscription),{class: "calendar-links-about"}) do
      = t("plans.about this plan")

    = link_to(edit_subscription_path(user_id: current_user.to_param, id: subscription),{class: "calendar-links-settings", title: settings_text}) do
      = settings_text

-# Links to scripture
.widget.scripture-links
  %h3.hd
    = t("plans.read today")
  %ul.menu.basic
    - unless references.empty?
      - references.each_with_index do |ref,index|
        %li.content_target{class: (content_page == index) ? "active #{content_page}" : nil }
          = form_tag(subscription_path(user_id: current_user.to_param, id: subscription), method: :put) do
            - # todo: sometimes day isn't passed with params. need to investigate
            = hidden_field_tag(:ref,            ref.reference.to_param)
            = hidden_field_tag(:completed,      (!ref.completed))
            = hidden_field_tag(:version,        subscription.version_id)
            = hidden_field_tag(:day_target,     day.to_s)
            = hidden_field_tag(:content_target, index )     if index != 0
            = check_box_tag(:completion, nil, ref.completed, {id:"#{index}_box",onChange: "this.form.submit()"} )

          - if content_page == index
            %span
              %b.mobile= t("plans.read today").capitalize
              = ref.reference.safe_human
          - else
            %a{href: (content_page == index) ? nil : subscription_path(user_id: current_user.to_param, id: subscription , day: day.to_s, content: (index > 0 ? index.to_s : nil), version: params[:version])}
              = ref.reference.safe_human

- if reading.devotional
  #widget-devotional.widget
    %h3.hd
      = t("plans.devotional")
    %div.bd
      = reading.devotional.html_safe

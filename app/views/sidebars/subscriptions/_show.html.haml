// Current Parameters:
// presenter: Presenter::Sidebar::Subscription

:ruby
  subscription  = presenter.subscription
  day           = presenter.day
  reading       = presenter.reading
  content_page  = presenter.content_page
  references    = reading.references

.mobile#mobile-sb-subscription{class: ('initial' if presenter.initial_load?)}
  .reader_modal_header
    %nav
      %a.close_btn.subscription_close_btn
    %nav.nav_right
      = link_to t("plan settings"), edit_user_subscription_path(current_user, plan_id: @plan.to_param), class: "settings_btn"

.widget.widget-notice{style: "width:268px;"}
  %p
    = t("plans.sidebar notice")
    %span.exit
      = link_to(t("plans.exit"), shelf_user_subscription_path(current_user, subscription, content: content_page, day: day ), method: :post)

#widget-plan-controls.widget

  - settings_text = t("settings")
  %div.hd
    = link_to subscription.name, plan_path(subscription)
    = link_to(edit_user_subscription_path(current_user,subscription),{class: "settings", title: settings_text}) do
      %span= settings_text

  #calendar.bd.nopad.calendar
    - cal_text = t("plans.calendar")

    %div.icon
      =link_to(calendar_user_subscription_path(current_user,subscription), {title: cal_text }) do
        %span= cal_text

    %div.day
      %h4= (subscription.respond_to?(:reading_date) ? subscription.reading_date(day) : current_date + (day - 1)).strftime('%a %b %-d')
      .mute= pluralize(references.size,"reading")

      // Next / Prev navigation
      - prev_text = t("plans.previous day") # used in 3 places below
      - if day > 1
        = link_to(user_subscription_path(current_user,subscription, day: ((day - 1) == subscription.current_day) ? nil : (day - 1), version: params[:version]), {class: "prev", title: prev_text }) do
          %span= prev_text
      - else
        = link_to("#", class: "disabled prev") do
          %span= prev_text

      - next_text = t("plans.next day") # used in 3 places below
      - if day <= subscription.total_days - 1
        = link_to(user_subscription_path(current_user, subscription, day: ((day + 1) == subscription.current_day) ? nil : (day + 1), version: params[:version]), {class: "next", title: next_text}) do
          %span= next_text
      - else
        = link_to("#", class: "disabled next") do
          %span= next_text

  %ul.menu.basic
    - unless references.empty?
      - references.each_with_index do |ref,index|
        %li.content_target{class: (content_page == index) ? "active #{content_page}" : nil }
          = form_tag(user_subscription_path(current_user, subscription), method: :put) do
            = hidden_field_tag(:ref,            ref.ref.to_usfm)
            = hidden_field_tag(:completed,      (!ref.completed?).to_s)
            = hidden_field_tag(:version,        subscription.version_id)
            = hidden_field_tag(:day_target,     day.to_s)
            = hidden_field_tag(:content_target, index )     if index != 0
            = check_box_tag(:completion, nil, ref.completed?, {id:"#{index}_box",onChange: "this.form.submit()"} )

          - if content_page == index
            %span
              %b.mobile= t("plans.read today").capitalize
              = ref.ref.safe_human
          - else
            %a{href: (content_page == index) ? nil : user_subscription_path(current_user, subscription , day: day.to_s, content: (index > 0 ? index.to_s : nil), version: params[:version])}
              = ref.ref.safe_human

- if reading.devotional
  #widget-devotional.widget
    %h3.hd
      = t("plans.devotional")
    %div.bd
      = reading.devotional.html_safe

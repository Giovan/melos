// Local parameters
// version:
// reference:
// alt_version:
// presenter:

:ruby
  direction = 'rtl' if version.try(:rtl?)
  reference_without_version = reference.to_s.rpartition(' ').first

- invalid_ref = defined?(invalid) and invalid == true

.fixed.after-header
  .row.full.b-border.white.collapse.reader-header
    .medium-12.columns.text-center
      .bcv-button-box
        =reader_previous_link(reference, {classes: "prev #{direction}","ngif": "!inNonDefaultLocale()", "uisref": "reader({version: previous_chapter_hash.version_id, usfm: previous_chapter_hash.usfm[0].toLowerCase()})", "id": "reader_previous"})
        =reader_previous_link(reference, {classes: "prev #{direction} ng-hide","ngif": "inNonDefaultLocale()", "uisref": "reader-locale({version: previous_chapter_hash.version_id, usfm: previous_chapter_hash.usfm[0].toLowerCase()})", "id": "reader_previous"})

        // need this H1 for SEO
        %h1
          %a.book{:id => "reader_book", "ng-bind" => "reader_book", "ng-click" => "togglePanel('showReaderBooks')", 'ng-disabled' => 'working'}= reference_without_version.rpartition(' ').first
          %a.chapter{:id => "reader_chapter", "ng-bind" => "reader_chapter", "ng-click" => "togglePanel('showReaderChapters')", 'ng-disabled' => 'working'}= reference_without_version.rpartition(' ').last
          %a.version{:id => "reader_version", "ng-bind" => "reader_version", 'ng-disabled' => 'working', "ng-click" => "togglePanel('showReaderVersions')"}= version.human
          %a.version.ng-hide{:id => "parallel_reader_version", "ng-bind" => "parallel_reader_version", 'ng-disabled' => 'working', "ng-click" => "togglePanel('showReaderVersions', true)", "ng-show" => "isParallelMode"}

        =reader_next_link(reference, {classes: "next #{direction}","ngif": "!inNonDefaultLocale()", "uisref": "reader({version: next_chapter_hash.version_id, usfm: next_chapter_hash.usfm[0].toLowerCase()})", "id": "reader_next"})
        =reader_next_link(reference, {classes: "next #{direction} ng-hide","ngif": "inNonDefaultLocale()", "uisref": "reader-locale({version: next_chapter_hash.version_id, usfm: next_chapter_hash.usfm[0].toLowerCase()})", "id": "reader_next"})

        -#%a#reader_next.next{"ng-disabled" => "working", "ng-click" => "loadChapter(null, {version: next_chapter_hash.version_id, usfm: next_chapter_hash.usfm[0].toLowerCase()})", "title" => "{{next_chapter_hash.usfm[0].toLowerCase()}}"}
      %a.icon.parallel-link{"ng-click" => "toggleParallelMode()"}
        %svg{"enable-background" => "new -322.2 298.5 726.6 612", :viewBox => "-322.2 298.5 726.6 612", :xmlns => "http://www.w3.org/2000/svg"}
          %path{:d => "M60.2,298.5H22h-344.2v612H22h38.2h344.2v-612H60.2z M22,872.2h-306V336.8H22C22,336.8,22,872.2,22,872.2z\n\t M366.2,872.2h-306V336.8h306V872.2z"}
      %a.icon.settings-audio.ng-hide{:title => t("ref.listen"), "ng-click" => "togglePanel('showReaderAudio')", "ng-class" => "{ 'active': showReaderAudio }", "ng-show" => "reader_audio.title"}
        %svg{"enable-background" => "new -282 373 47 48", :viewBox => "-282 373 47 48", :xmlns => "http://www.w3.org/2000/svg"}
          %path{:d => "M-250 421l-1.6-3.4s12.8-5.4 12.8-20.6c0-15.3-12.8-20.5-12.8-20.5l1.6-3.5s15 6.5 15 24-15 24-15 24zm2.7-24c0 9-8.2 12.6-8.2 12.6l-1.6-3.5s5.9-2.4 5.9-9.1c0-7.3-5.8-9.4-5.8-9.4l2.1-3.4c.1 0 7.6 3.6 7.6 12.8zm-32.8 5.6c-1.2 0-1.9-.5-1.9-1.9v-6.5c0-1.1.8-1.8 1.9-1.8h5.3l10.4-10.5v31.1l-10.3-10.4h-5.4z"}
      %a.icon.settings-font{:title => t("ref.settings"), "ng-click" => "togglePanel('showReaderFont')", "ng-class" => "{ 'active': showReaderFont }"}
        %svg{"enable-background" => "new -295 390 20 13", :viewBox => "-295 390 20 13", :xmlns => "http://www.w3.org/2000/svg"}
          %path{:d => "M-290.3 390h1.9l4.6 12.7h-1.9l-1.3-3.8h-5l-1.4 3.8h-1.8l4.9-12.7zm2.9 7.5l-1.9-5.6-2 5.6h3.9zm9.1-.4c.4 0 .6-.2.7-.4.1-.1.1-.3.1-.6 0-.5-.2-.9-.6-1.2-.4-.2-.9-.4-1.6-.4-.8 0-1.4.2-1.7.7-.2.2-.3.6-.4 1.1h-1.4c0-1.1.4-1.9 1.1-2.4s1.5-.7 2.5-.7c1.1 0 2 .2 2.6.6.7.4 1 1.1 1 1.9v5.3c0 .2 0 .3.1.4.1.1.2.1.4.1h.5v1.1c-.2.1-.4.1-.5.1h-.5c-.5 0-.9-.2-1.2-.6-.1-.2-.2-.5-.3-.9-.3.4-.8.8-1.4 1.1-.6.3-1.2.5-1.9.5-.9 0-1.5-.3-2.1-.8-.5-.5-.8-1.2-.8-2 0-.9.3-1.5.8-2s1.2-.8 2.1-.9h2.5zm-3.3 4.2c.3.3.7.4 1.2.4s1.1-.1 1.6-.4c.9-.4 1.3-1.1 1.3-2.1v-1.2c-.2.1-.4.2-.7.3s-.6.1-.9.2l-.9.1c-.6.1-1 .2-1.3.4-.5.3-.7.7-.7 1.3-.1.4.1.7.4 1z"}

      %div{"reader-text-settings-panel" => true, "font-size" => "readerFontSize", "font-family" => "readerFontFamily", "show-footnotes" => "showFootnotes", "show-cross-references" => "showCrossReferences", "show-numbers-and-titles" => "showNumbersAndTitles", "ng-show" => "showReaderFont" }
      %div{"reader-audio-panel" => true, "ng-show" => "showReaderAudio", "audio-data" => "reader_audio" }

      -#=render partial: 'shared/menu_settings'
      =render partial: 'shared/book_selector', locals: {presenter: presenter}
      =render partial: 'shared/version_selector/display', locals: {presenter: presenter}
      -#=render partial: 'shared/menu_audio_player', locals: { reference: reference }
-#
  / #m-toolbar.mobile
  /   %div.verse_toolbar{class: ('authed' if current_auth)}
  /     %nav
  /       %a.submenu_btn.highlight_btn{href: 'javascript:void(0);'}
  /       %a.submenu_btn.bookmark_btn{href: 'javascript:void(0);', "data-action" => bookmarks_path, "data-method" => 'POST'}
  /       %a.submenu_btn.note_btn{href: 'javascript:void(0);', "data-action" => new_note_path, "data-method" => 'GET'}
  /       %a.submenu_btn.related_btn{href: "/moments/related?v=#{version.id}&usfm=#{reference.chapter_usfm}"}
  /       %a.submenu_btn.share_btn{href: 'javascript:void(0);', "data-action" => new_share_path, "data-method" => 'GET'}
  /     %div.close_tab
  /       %span.first
  /       %div.mid
  /         %a.menu_close.verse_close_btn
  /       %span.last

  /   %div.color_toolbar
  /     %nav
  /       %form.highlights{action: (current_auth ? highlights_path : sign_up_path), method: (current_auth ? "POST" : "GET")}
  /         - if current_auth.nil?
  /           %input{type: 'hidden', name: 'redirect', value: "/bible"}
  /           %input{type: 'hidden', name: 'source', value: "highlight"}

  /         %input.references.verses_selected_input{name: "highlight[references]", type: "hidden"}

  /         %div.color_picker_list
  /           %button.color.color_picker_clear{type:"submit", name: "remove", value: "true", id:"clear_highlights"}
  /           %span#dup_mobile_highlights

  /       %div.clear
  /     .mobile
  /       %div.close_tab
  /         %span.first
  /         %div.mid
  /           %a.menu_close.highlight_close_btn
  /         %span.last

  / #m-navitems.mobile

  /   %div.reader-nav{class: reference.audio ? nil : "audio-disabled"}
  /     %span.first
  /     %ul
  /       %li=reader_previous_link(reference, {classes: "prev #{direction}"})
  /       %li
  /         %a.button.reader_settings_btn{:href => 'javascript:void(0);'}
  /           %span.icon_reader_settings
  /       %li{class: ("audio-disabled" unless version.audio_version?)}
  /         %a.button.audio_btn{:href => '#menu_audio_player', :title => t("ref.listen")}
  /           %span.icon_listen
  /           =t("ref.listen")
  /       %li= reader_next_link(reference, {classes: "next #{direction}"})
  /     %span.last
  /   %br.clear

  / #reader_header
  /   %header
  /     %ul.float_left
  /       %li{class: version.rtl? ? "rtl" : nil}
  /         %a.dynamic_menu_trigger.drop_down_select{:href => '#menu_book_chapter', id:"menu_book_chapter_trigger", :title => t("ref.choose book and chapter")}
  /           %h2
  /             = truncate(reference.to_s(version: false), length: 40, separator: " ")
  /           %span
  /             = t('ref.choose book and chapter')
  /       %li
  /         %a.dynamic_menu_trigger.drop_down_select{href:"#menu_version", id:"menu_version_trigger", title: t("ref.choose version")}
  /           %h2
  /             = version.human
  /           %span
  /             =t("ref.choose version")
  /       %li{style: 'display:none;'}
  /         %a{href: version_path(version)}
  /           %h2
  /             = version.to_s
  /     - unless invalid_ref
  /       %ul.float_right.header-options
  /         - if alt_version.present?
  /           %li.show_in_parallel_mode
  /             %a.dynamic_menu_trigger.drop_down_select.header-options-version{href:"#menu_version", id:"menu_alt_version_trigger", title: t("ref.choose second version")}
  /               %b
  /                 = alt_version.human
  /               %span
  /                 =t("ref.choose version")
  /         %li.hide_in_parallel_mode
  /           %a.button.dynamic_menu_trigger.header-options-settings{href:"#menu_settings", id:"menu_settings_trigger", title:t("ref.settings")}
  /             %span.icon_settings
  /               =t("ref.settings")
  /         %li.hide_in_parallel_mode
  /           %a.button.header-options-audio{:href => reference.audio ? '#menu_audio_player' : nil, :title => reference.audio ? t("ref.listen"): t('audio.none'), class: reference.audio ? "dynamic_menu_trigger" : "disabled"}
  /             %span.icon_listen{class: reference.audio ? nil : "disabled"}
  /               =t("ref.listen")
  /         %li.hide_in_parallel_mode
  /           %a.button.header-options-full#button_full_screen{:href => '#', :title => t("ref.full screen")}
  /             %span.icon_full_screen
  /               =t("ref.full screen")
  /         - unless presenter.verses.present? and !presenter.respond_to?(:subscription)
  /           %li.float_right_in_parallel_mode
  /             %a.header-options-parallel#button_read_parallel.button{:href => '#', :title => t("ref.parallel")}
  /               %span.icon_parallel
  /                 =t("ref.parallel")

  / #menu_verse_actions.clearfix
  /   .references
  /     %ul.reference_tokens

  /   .panel-tabs
  /     %span.highlight.tab-trigger{"data-pane-type"=>"highlight"}
  /       = t("highlight")
  /       .arrow
  /     %span.bookmark.tab-trigger{"data-pane-type"=>"bookmark"}
  /       = t("bookmark")
  /       .arrow
  /     %span.note.tab-trigger{"data-pane-type" => "note"}
  /       = t("new note")
  /       .arrow
  /     %span.link.tab-trigger
  /       = t("link")
  /       .arrow
  /     %span.share.tab-trigger{"data-pane-type"=>"share"}
  /       = t("ref.share")
  /       .arrow
  /     %span.related.tab-trigger
  /       %span.count
  /     %span.clear-selected.tab-trigger
  /       = t('ref.clear verses')

  /   .panels



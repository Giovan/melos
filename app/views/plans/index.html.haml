- @title = "#{t('plans.title')}: #{t('plans.browse plans', category: @category.label || t('plans.all'))}"
- translate = params[:translate] == "true"

- content_for :meta_description do
  = "#{t('plans.title')}: #{t('plans.browse plans', category: @category.label || t('plans.all'))}"

- content_for :title do
  = t("plans.title")

%article#plan-index
  - if current_auth
    %h1.float_left
      = t("plans.browse plans", category: @category.label || t("plans.all"))
    %dl.combo_button.float_right
      %dt
      %dd.highlighted
        = link_to t("plans.all plans"), plans_path
      %dd
        = link_to t("plans.my plans"), subscriptions_path(user_id: current_user.to_param)
  - else
    %h1
      = t("plans.browse plans", category: @category.label || t("plans.all"))

  .split_pane
    .sidebar
      .search

        %form#plan-search{method: 'get', action: request.fullpath}
          - if params[:category]
            %input{type: "hidden", name: "category", value: params[:category]}
          - if params[:translate]
            %input{type: "hidden", name: "translate", value: params[:translate]}
          - if @plan_lang
            %input{type: "hidden", name: "lang", value: @plan_lang}
          %input.field.autofocus{name: "query", type: 'search', placeholder: t("plans.search placeholder", category: @category.label || t("plans.all")), value: params[:query]}
          %input.submit{type: 'submit', value: t("plans.search"), onClick: "$('select.language').attr('disabled','true');"}

        %form{method: 'get', action: request.fullpath}
          %input{type: "hidden", name: "translate", value: (params[:translate] || "true")}
          - if params[:category]
            %input{type: "hidden", name: "category", value: params[:category]}
          - if params[:query]
            %input{type: "hidden", name: "query", value: params[:query]}

          %select.language{onChange: "this.form.submit();", name: "lang"}
            - (Plan.available_locales & I18n.available_locales).each do |loc|
              %option{value: loc.to_s, selected: loc.to_s == @plan_lang.to_s}
                = t("language name", locale: loc)

      %dl
        %dt
          = t("plans.browse by category")
          - if translate
            - orig_locale = I18n.locale
            - I18n.locale = @plan_lang
        %dd{class: (params[:category] == "" || params[:category].nil?) ? "highlighted" : ""}
          = link_to t("plans.all plans"), plans_path(params.merge(category: nil, locale: orig_locale))
        - level = 0
        - if @category
          - if @category.breadcrumbs
            - @category.breadcrumbs.each do |category|
              - level += 1
              %dd{class: params[:category] == category.slug ? "highlighted" : ""}
                %a{href: plans_path(params.merge(locale: orig_locale, category: category.slug)), style: "margin-left:#{level * 20}px"}
                  = (params[:category] == category.slug) ? t("plans.all category plans", category: category.label)  : category.label
            - level += 1
          - if @category.children
            - @category.children.each do |category|
              %dd{class: params[:category] == category.slug ? "highlighted" : ""}
                %a{:href => plans_path(params.merge(locale: orig_locale, category: category.slug)), :style => "margin-left:#{level * 20}px"}
                  = category.label
    .content

      - I18n.locale = orig_locale
      - if I18n.locale.to_s != @plan_lang.to_s

        #filter-message
          = t('plans.showing language filtered', lang_name: t('language name', locale: @plan_lang))
          %span.mute{style: "font-weight: normal; font-size: 12px"}
            = t("plans.swap list localization", swap_locale: t('language name', locale: translate ? I18n.locale : @plan_lang), swap_link: url_for(params.merge(translate: nil, lang: I18n.locale))).html_safe

      - if @plans.present?
        %ul.resource_list
          = render partial: "plans/list_item", collection: @plans, locals: {original_locale: orig_locale}

        %ul.pagination
          - if @plans.prev_page || @page > 1
            %li.prev
              =link_to t("ui.pagination.previous page"), url_for({query: params[:query], category: params[:category],page: @plans.prev_page || @page - 1, locale: params[:locale], lang: params[:lang]}), rel: 'prev', class: "action_button_grey action_button"
          - if @plans.next_page
            %li.next
              =link_to t("ui.pagination.next page"), url_for({query: params[:query], category: params[:category], page: @plans.next_page, locale: params[:locale], lang: params[:lang]}), rel: 'next', class: "action_button_grey action_button"

      -else
        .none{align: "center"}= t("plans.none found")



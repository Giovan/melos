From 0c48e9fee1f99c81f543dfd7627266b9fd1dc28d Mon Sep 17 00:00:00 2001
From: Caedmon Judd <caedmon@statebuilt.com>
Date: Mon, 24 Oct 2011 16:11:54 -0500
Subject: [PATCH 20/55] Notes work

---
 app/controllers/notes_controller.rb       |   22 ++--------
 app/models/note.rb                        |    1 +
 app/views/notes/show.html.haml            |    3 +-
 features/notes.feature                    |    4 +-
 fixtures/vcr/cuke/cucumber_tags/bible.yml |   62 +++++++++++++++++++++++++++++
 5 files changed, 72 insertions(+), 20 deletions(-)

diff --git a/app/controllers/notes_controller.rb b/app/controllers/notes_controller.rb
index ff8be24..941241c 100644
--- a/app/controllers/notes_controller.rb
+++ b/app/controllers/notes_controller.rb
@@ -24,16 +24,12 @@ class NotesController < ApplicationController
   end
 
   def create
-    @note = Note.new(params)
+    @note = Note.new(params[:note])
     @note.auth = current_auth
-    
+
     if @note.save
       render action: "show"
     else
-      flash[:alert] = []
-      @note.errors.each do |error|       
-        flash.now[:alert] << error
-      end
       render action: "new"
     end    
   end
@@ -45,24 +41,16 @@ class NotesController < ApplicationController
     if @note.update_attributes(params[:note])
       render action: "show"
     else
-      flash[:alert] = []
-      @note.errors.each do |error|       
-        flash.now[:alert] << error
-      end
       render action: "edit"
-    end       
+    end
   end
   
-  def delete
+  def destroy
     @note = Note.find(params[:id], current_auth)
-    
+debugger    
     if @note.destroy
       redirect_to '/'
     else
-      flash[:alert] = []
-      @note.errors.each do |error|       
-        flash.now[:alert] << error
-      end
       render action: "index"
     end
   end
diff --git a/app/models/note.rb b/app/models/note.rb
index b52a8c3..6712c84 100644
--- a/app/models/note.rb
+++ b/app/models/note.rb
@@ -33,6 +33,7 @@ class Note
   def self.find(id, auth) 
     response = YvApi.get('notes/view', {:id => id, :auth => auth} ) do |errors|     
       @errors = errors.map { |e| e["error"] }
+puts @errors      
       return false
     end
 
diff --git a/app/views/notes/show.html.haml b/app/views/notes/show.html.haml
index 02de729..6a82c30 100644
--- a/app/views/notes/show.html.haml
+++ b/app/views/notes/show.html.haml
@@ -10,4 +10,5 @@
   = @note.reference
   = label_tag :user_status, "Note Status:"
   = @note.user_status
-  = link_to 'edit', edit_note_path(@note.id)
\ No newline at end of file
+  = link_to 'edit', edit_note_path(@note.id)
+  = link_to 'delete this note', note_path(@note.id), :confirm => 'Are you sure?', :method => :delete
\ No newline at end of file
diff --git a/features/notes.feature b/features/notes.feature
index 4b926b7..6ae61d2 100644
--- a/features/notes.feature
+++ b/features/notes.feature
@@ -10,9 +10,9 @@ Feature: Notes view
     When I go to the new note page
     And I fill in "Title" with "Note Title" 
     And I fill in "Content" with "Note Content" 
-    And I select "King James Version" from the dropdown "version"
+    And I select "King James Version" from the dropdown "note_version"
     And I fill in "Reference" with "gen.1.1" 
-    And I select "Public" from the dropdown "user_status"
+    And I select "Public" from the dropdown "note_user_status"
     And I click "Save" 
     Then I should be on a show note page
     And I should see "Note Title" 
diff --git a/fixtures/vcr/cuke/cucumber_tags/bible.yml b/fixtures/vcr/cuke/cucumber_tags/bible.yml
index 4c731be..b60f076 100644
--- a/fixtures/vcr/cuke/cucumber_tags/bible.yml
+++ b/fixtures/vcr/cuke/cucumber_tags/bible.yml
@@ -780,3 +780,65 @@
     body: ! '{"response":{"code":200,"data":{"id":"4163176","username":"testuser2","user_avatar_url":{"px_24x24":"http:\/\/avatars.youversion.com\/58dd024d49e1d1b83a5d307f09f32734_24x24.png","px_48x48":"http:\/\/avatars.youversion.com\/58dd024d49e1d1b83a5d307f09f32734_48x48.png","px_128x128":"http:\/\/avatars.youversion.com\/58dd024d49e1d1b83a5d307f09f32734_128x128.png","px_512x512":"http:\/\/avatars.youversion.com\/58dd024d49e1d1b83a5d307f09f32734_512x512.png"},"name":null,"first_name":null,"last_name":null,"location":null,"im_type":null,"im_value":null,"website":null,"language":"false","country":"  ","timezone":"UTC","created":"2011-10-21
       13:23:17.36098+00","last_login":"2011-10-24 19:11:46+00"},"buildtime":"2011-10-24T19:14:48+00:00"}}'
     http_version: '1.1'
+- !ruby/struct:VCR::HTTPInteraction
+  request: !ruby/struct:VCR::Request
+    method: :get
+    uri: http://testuser:tenders@api.yvdev.com:80/2.3/notes/view.json?id=935772
+    body: !!null 
+    headers:
+      referer:
+      - http://web.youversion.com
+  response: !ruby/struct:VCR::Response
+    status: !ruby/struct:VCR::ResponseStatus
+      code: 200
+      message: OK
+    headers:
+      server:
+      - nginx/0.7.67
+      date:
+      - Mon, 24 Oct 2011 20:52:46 GMT
+      content-type:
+      - text/plain; charset=utf-8
+      transfer-encoding:
+      - chunked
+      connection:
+      - keep-alive
+      vary:
+      - Accept-Encoding
+    body: ! '{"response":{"code":200,"data":{"id":"935772","user_id":"4163177","username":"testuser","user_avatar_url":{"px_24x24":"http:\/\/avatars.youversion.com\/5d9c68c6c50ed3d02a2fcf54f63993b6_24x24.png","px_48x48":"http:\/\/avatars.youversion.com\/5d9c68c6c50ed3d02a2fcf54f63993b6_48x48.png","px_128x128":"http:\/\/avatars.youversion.com\/5d9c68c6c50ed3d02a2fcf54f63993b6_128x128.png","px_512x512":"http:\/\/avatars.youversion.com\/5d9c68c6c50ed3d02a2fcf54f63993b6_512x512.png"},"title":"Public
+      Note","highlight_color":null,"content_yvml":"<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<!DOCTYPE
+      yv-note SYSTEM \"http:\/\/api.yvdev.com\/pub\/yvml_1_0.dtd\">\n<yv-note>Public
+      Content<\/yv-note>","content_html":"Public Content","content_html_android":"Public
+      Content","content_html_ios":"Public Content","content_text":"Public Content","url":"\/notes\/935772\/public-note","short_url":"http:\/\/dev.read.ly\/n\/3vR6","rich_content":false,"language_iso":null,"rank":"0","reference":[{"osis":"Gen.1.1","human":"Genesis
+      1:1"}],"version":"kjv","created":"2011-10-24 18:45:40+00","published":null,"updated":"2011-10-24
+      18:45:40.741929+00","user_status":"draft","system_status":"new"},"buildtime":"2011-10-24T20:52:46+00:00"}}'
+    http_version: '1.1'
+- !ruby/struct:VCR::HTTPInteraction
+  request: !ruby/struct:VCR::Request
+    method: :post
+    uri: http://testuser:tenders@api.yvdev.com:80/2.3/notes/create.json
+    body: title=&content=%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3C!DOCTYPE%20yv-note%20SYSTEM%20%22http%3A%2F%2Fapi.yvdev.com%2Fpub%2Fyvml_1_0.dtd%22%3E%3Cyv-note%3E%3C%2Fyv-note%3E&language_iso=&reference=&version=&published=&user_status=&shared_connections=&token=615ad51b71049e299842f5af14c70cad
+    headers:
+      referer:
+      - http://web.youversion.com
+  response: !ruby/struct:VCR::Response
+    status: !ruby/struct:VCR::ResponseStatus
+      code: 200
+      message: OK
+    headers:
+      server:
+      - nginx/0.7.67
+      date:
+      - Mon, 24 Oct 2011 20:54:47 GMT
+      content-type:
+      - text/plain
+      - text/plain; charset=utf-8
+      transfer-encoding:
+      - chunked
+      connection:
+      - keep-alive
+      vary:
+      - Accept-Encoding
+    body: ! '{"response":{"code":400,"data":{"errors":[{"key":"notes.content.empty_document","error":"Document
+      content cannot be empty"}]},"buildtime":"2011-10-24T20:54:47+00:00"}}'
+    http_version: '1.1'
-- 
1.7.0.4


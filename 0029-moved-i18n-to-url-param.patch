From 460d9443ae4bba11295ebf8f38b19475c29c9438 Mon Sep 17 00:00:00 2001
From: Chad Bailey <chadbailey@gmail.com>
Date: Wed, 26 Oct 2011 11:02:46 -0500
Subject: [PATCH 29/55] moved i18n to url param

Change-Id: Ice26fb1c79005bdcc1b1ce4ed33b52c918af01d2
---
 Gemfile                                         |    1 +
 app/controllers/application_controller.rb       |   16 ++++++----------
 app/helpers/url_helper.rb                       |   11 -----------
 app/views/layouts/application.html.haml         |    2 +-
 config/initializers/i18n.rb                     |    2 ++
 config/initializers/quiet_assets.rb             |    7 +++++++
 config/routes.rb                                |    3 ++-
 features/i18n.feature                           |   14 ++++++++++++++
 features/step_definitions/yv_steps.rb           |    4 ++++
 features/support/paths.rb                       |    2 ++
 spec/controllers/application_controller_spec.rb |   20 --------------------
 11 files changed, 39 insertions(+), 43 deletions(-)
 create mode 100644 config/initializers/i18n.rb
 create mode 100644 config/initializers/quiet_assets.rb
 create mode 100644 features/i18n.feature

diff --git a/Gemfile b/Gemfile
index d70b812..0573b7d 100644
--- a/Gemfile
+++ b/Gemfile
@@ -8,6 +8,7 @@ gem 'cells'
 gem 'haml-rails', "  ~> 0.3.4"
 gem 'jquery-rails'
 gem 'pg'
+gem 'routing-filter'
 
 # Gems used only for assets and not required
 # in production environments by default.
diff --git a/app/controllers/application_controller.rb b/app/controllers/application_controller.rb
index 2dd4a85..7e516a9 100644
--- a/app/controllers/application_controller.rb
+++ b/app/controllers/application_controller.rb
@@ -1,25 +1,21 @@
 class ApplicationController < ActionController::Base
-  include UrlHelper
   protect_from_forgery
   helper_method :current_auth, :current_user
   before_filter :set_locale
 
   # Set locale
   def set_locale
-    puts request.subdomains.first
-    return redirect_to params.merge(host: with_subdomain("www")) if request.subdomains.empty?
-    parsed_locale = request.subdomains.first
-    if parsed_locale == "www"
+    parsed_locale = params[:locale]
+    if parsed_locale == nil
       cookies[:locale].blank? ? visitor_locale = I18n.default_locale : visitor_locale = cookies[:locale].to_sym
-      cookies.permanent[:locale] = {value: visitor_locale, domain: request.domain}
-      return redirect_to params.merge(host: with_subdomain(visitor_locale.to_s)) unless visitor_locale == :en
+      cookies.permanent[:locale] = visitor_locale
+      return redirect_to params.merge!(locale: visitor_locale) unless visitor_locale == :en
     else
       visitor_locale = I18n.available_locales.include?(parsed_locale.to_sym) ? parsed_locale.to_sym : :en
-      cookies.permanent[:locale] = {value: visitor_locale, domain: request.domain}
-      return redirect_to params.merge(host: with_subdomain("www")) if visitor_locale == :en
+      cookies.permanent[:locale] = visitor_locale
+      return redirect_to params.merge!(locale: "") if visitor_locale == :en
     end
     I18n.locale = visitor_locale
-    puts I18n.locale
   end
 
   # Manually throw a 404
diff --git a/app/helpers/url_helper.rb b/app/helpers/url_helper.rb
index 0b82217..4f03cdb 100644
--- a/app/helpers/url_helper.rb
+++ b/app/helpers/url_helper.rb
@@ -1,14 +1,3 @@
 module UrlHelper
-  def with_subdomain(subdomain)
-    subdomain = (subdomain || "www")
-    subdomain += "."
-    [subdomain, request.domain].join
-  end
 
-  def url_for(options = nil)
-    if options.kind_of?(Hash) && options.has_key?(:subdomain)
-      options[:host] = with_subdomain(options.delete(:subdomain))
-    end
-    super
-  end
 end
\ No newline at end of file
diff --git a/app/views/layouts/application.html.haml b/app/views/layouts/application.html.haml
index c14e0a2..13aa968 100644
--- a/app/views/layouts/application.html.haml
+++ b/app/views/layouts/application.html.haml
@@ -16,4 +16,4 @@
     = yield
     %select#choose_language{name: "choose_language"}
       - I18n.available_locales.each do |loc|
-        %option{value: loc, href: url_for(params.merge!(host: with_subdomain(loc.to_s))), selected: loc == I18n.locale}= t("language name", locale: loc)
\ No newline at end of file
+        %option{value: loc, href: url_for(params.merge!(locale: loc)), selected: loc == I18n.locale}= t("language name", locale: loc)
\ No newline at end of file
diff --git a/config/initializers/i18n.rb b/config/initializers/i18n.rb
new file mode 100644
index 0000000..8e13ca3
--- /dev/null
+++ b/config/initializers/i18n.rb
@@ -0,0 +1,2 @@
+RoutingFilter::Locale.include_default_locale = false
+
diff --git a/config/initializers/quiet_assets.rb b/config/initializers/quiet_assets.rb
new file mode 100644
index 0000000..829c390
--- /dev/null
+++ b/config/initializers/quiet_assets.rb
@@ -0,0 +1,7 @@
+Rails.application.assets.logger = Logger.new('/dev/null')
+Rails::Rack::Logger.class_eval do
+  def before_dispatch_with_quiet_assets(env)
+    before_dispatch_without_quiet_assets(env) unless env['PATH_INFO'].index("/assets/") == 0
+  end
+  alias_method_chain :before_dispatch, :quiet_assets
+end
\ No newline at end of file
diff --git a/config/routes.rb b/config/routes.rb
index 63d77b4..0db5238 100644
--- a/config/routes.rb
+++ b/config/routes.rb
@@ -1,4 +1,5 @@
-YouversionWeb::Application.routes.draw do@
+YouversionWeb::Application.routes.draw do
+  filter :locale, include_default_locale: false
   # Bible
   match 'bible(/:reference)' => 'references#show', :as => 'bible', :constraints => {:reference => /.*/}
   resources 'versions', :only => [:index, :show]
diff --git a/features/i18n.feature b/features/i18n.feature
new file mode 100644
index 0000000..0b57939
--- /dev/null
+++ b/features/i18n.feature
@@ -0,0 +1,14 @@
+Feature: i18n/Localization
+  In order to: Read the Bible in my own language
+  As a:        Visitor
+  I want to:   Set the site language.
+
+  @i18n
+  Scenario: English/French
+    When I go to "/sign-in"
+    Then "en" should be selected for "choose_language"
+    When I go to "/de/sign-in"
+    Then "de" should be selected for "choose_language"
+    When I go to "/sign-in"
+    Then I should be on "/de/sign-in"
+    And "de" should be selected for "choose_language"
\ No newline at end of file
diff --git a/features/step_definitions/yv_steps.rb b/features/step_definitions/yv_steps.rb
index d51b248..8dde58d 100644
--- a/features/step_definitions/yv_steps.rb
+++ b/features/step_definitions/yv_steps.rb
@@ -20,6 +20,10 @@ Then /^"([^"]*)" should be selected for "([^"]*)"$/ do |value, field|
   page.should have_xpath("//option[@selected and @value = '#{value}']")
 end
 
+Then /^"(.*)" should be selected$/ do |value|
+  with_scope("selected") { page.should have_content value }
+end
+
 Then /^an unverified user named "([^"]*)" with password "([^"]*)" should exist$/ do |arg1, arg2|
   lambda do
     YvApi.get("users/authenticate", auth_username: arg1, auth_password: arg2)
diff --git a/features/support/paths.rb b/features/support/paths.rb
index 3b0aa04..56a40d4 100644
--- a/features/support/paths.rb
+++ b/features/support/paths.rb
@@ -18,6 +18,8 @@ module NavigationHelpers
       sign_up_path
     when /^the version page for \"(.*)\"$/
       version_path $1
+    when /^"([^"]*)"$/
+      $1
 
     # Add more mappings here.
     # Here is an example that pulls values out of the Regexp:
diff --git a/spec/controllers/application_controller_spec.rb b/spec/controllers/application_controller_spec.rb
index 2f7df1c..afe76dc 100644
--- a/spec/controllers/application_controller_spec.rb
+++ b/spec/controllers/application_controller_spec.rb
@@ -1,25 +1,5 @@
 require 'spec_helper'
 
 describe ApplicationController do
-  controller do
-    def index
-      render text: "foo"
-    end
-  end
 
-  describe "#set_locale" do
-    it "sets locale to en for www" do
-      request.host = "www.youversion.com"
-      get :index
-      I18n.locale.should == :en
-      response.cookies["locale"].should == "en"
-    end
-
-    it "sets locale to fr for fr" do
-      request.host = "fr.youversion.com"
-      get :index
-      I18n.locale.should == :fr
-      response.cookies["locale"].should == "fr"
-    end
-  end
 end
\ No newline at end of file
-- 
1.7.0.4

